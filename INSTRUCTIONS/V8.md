# Cursor-ohje | PDF-tyyppireititin — Canvas v8

## Tarkoitus (v8)
V7 mini-run (5 sivua) onnistui:
- TOC tunnistuu ja muunnetaan list_itemeiksi
- financial_type poimitaan TOC:sta
- OCRQualityChecker raportoi bad-laadun sivuille 1–2

Puute: **Adaptive PSM ei ole vielä integroituna**, ja seuraava kriittinen askel on **full-run (154 sivua)** sekä **edistyneet QA-checkerit** (tuloslaskelma/tase/ristiviittaukset/diff).

---

# 0) V8-periaate

> Ennen advanced-QA:ta: OCR stabiloidaan adaptiivisella PSM:llä, ja full-run läpäisee laatugatet.

---

# 1) Gate A — Adaptive PSM integroituna Step 41B:hen

## 1.1 Toteutus: monipassi OCR vain huonoille sivuille
Vaatimus:
- Aja ensin normaali OCR (Pass 1)
- Jos `ocr_quality.status == bad` TAI `repeat_run_max >= 10`:
  - aja Pass 2 eri PSM:llä
  - valitse paras pass `ocr_quality.score` mukaan

Suosituspassit (Tesseract):
- Pass 1: `PSM=6` (oletus)
- Pass 2: `PSM=11` (sparse text)
- Pass 3 (vain jos yhä bad): `PSM=3` tai `PSM=4`

## 1.2 Valintalogiikka (deterministinen)
Valitse paras output:
- korkein `alpha_ratio`
- matalin `repeat_run_max`
- pienin `junk_token_ratio`
- (tie-breaker) suurempi merkkimäärä, mutta katto: estä pelkkä kohina

Kirjaa `ocr_pass_used` per sivu.

---

# 2) Gate B — Full-run laatugate (154 sivua)

## 2.1 Full-run ei mene läpi jos
- yli X% sivuista on `ocr_quality.status == bad`
  - aluksi X = 10% (tiukka)
  - jos skannaus on heikko, käytä X = 20% (väliaikainen)

## 2.2 Output-ankkurit (pakolliset)
Full-run jälkeen:
- `document.json` ei tyhjä
- `semantic_section` täytetty kaikille sivuille
- TOC-sivut > 0
- `financial_type` löytyy vähintään:
  - income_statement
  - balance_sheet
  - cash_flow_statement
  - notes

---

# 3) Gate C — Primary statement -sivujen haku TOC:sta

## 3.1 TOC → target pages
TOC-list_items sisältää sivunumeroita. Lisää parseri:
- poimi rivin lopusta sivunumero (1–3 numeroa)
- tallenna `toc_target_page`

Esimerkki:
- "8.3 Tase ... 134" → `balance_sheet`, target_page=134

## 3.2 Sivunumero → PDF-page_index mappaus
Tilinpäätöksissä sivunumero != pdf page index.
Tee mappaus:
- löydä ensimmäinen paikka jossa sivun alatunnisteessa näkyy "1" tai "2" jne.
- laske offset
- tallenna `page_number_offset`

---

# 4) Gate D — Advanced QA checkers (minimiversiot)

Ota käyttöön nämä neljä, mutta **vain** primary statement -sivuilla:

## 4.1 SumConsistencyChecker (tuloslaskelma)
- tunnista rivit joissa on "Yhteensä" / "Summa" / "Total"
- tarkista, että alaerien summa ≈ yhteensä (toleranssi 0.5–2.0)

## 4.2 BalanceSheetEquationChecker (tase)
- tunnista "Vastaavaa" ja "Vastattavaa" (tai Assets/Liabilities)
- tarkista, että vastaavaa ≈ vastattavaa

## 4.3 CrossRefChecker (liitetiedot)
- poimi viittaukset kuten "liite"/"note" + numero
- varmista, että liite löytyy notes-osiosta

## 4.4 DiffChecker (regressio)
- tallenna golden-output (valitut sivut)
- vertaile:
  - item-count
  - financial_type count
  - OCR quality summary

---

# 5) Gate E — Visual tables (valinnainen, rajattu)

Älä aja visual-table -polkua kaikkialle.
Aja vain sivuille:
- `financial_type in {income_statement, balance_sheet, cash_flow_statement}`
- ja `ocr_quality.status != bad` (tai improved pass jälkeen)

---

# 6) V8-ajojärjestys

1) Mini-run uudestaan samoilla 5 sivulla → todista, että adaptive PSM parantaa sivuja 1–2
2) Full-run 154 sivua
3) TOC → target pages → aja advanced QA vain löydetyille primary statement -sivuille
4) Tuota `qa_report.json` jossa on:
   - OCRQualityChecker summary
   - Sum/Balance/CrossRef findings
   - DiffChecker regressioraportti

---

# 7) V8 Definition of Done

V8 on valmis, kun:
- Adaptive PSM valitsee paremman passin bad-sivuille (näkyy `ocr_pass_used`)
- Full-run läpäisee laatugaten
- Primary statements tunnistuvat (financial_type löytyy ja target-pages mappautuu)
- Advanced QA tuottaa vähintään yhden järkevän tarkistuksen per statement-tyyppi

---

**Muistisääntö:**
> V7 opetti mitä on TOC. V8 opettaa miten löydetään tase/tulos ja validoidaan numerot.

