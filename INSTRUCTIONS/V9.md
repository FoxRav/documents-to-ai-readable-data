# PROJEKTI | KuntaParse / PDF-tyyppireititin — Roadmap & Ohjeet (v0)

## 0) Tavoite
Rakennetaan tuotantokelpoinen dokumentti- ja kuva-parse-pipeline, joka tuottaa **lähes 100% oikein** rakenteellisen datan (JSON + Markdown) vaativista aineistoista.

Tuettavat syötteet:
1) **Digitaalinen PDF** (natiivi teksti + taulukot)
2) **Skannattu PDF** (OCR + taulukot)
3) **Kuvat (JPG/PNG)**
   - yleiset dokumentit (OCR)
   - **nuottisivut (OMR)**

Tavoitekäyttö:
- 150–200 sivun kaupungin tilinpäätös (taulukot, teksti, liitteet)
- yksittäiset kuvasivut, kuten nuottisivu

---

## 1) Projektin periaatteet

### 1.1 Ei-nolladata sääntö
- Tyhjä `document.json` = epäonnistunut ajo, vaikka pipeline ei kaatuisi.

### 1.2 Gate-kehitys (iteratiivinen)
- Jokainen versio lisää yhden “gate”-tason onnistumiskriteerin.
- Ensin data → sitten semantiikka → sitten QA → sitten optimointi.

### 1.3 Luotettavuus
- Fallbackit ovat pakollisia (tyhjä tulos = fallback tai FAIL).
- Kaikki tärkeät päätökset logitetaan ja ovat auditoitavissa.

---

## 2) Arkkitehtuuri (korkea taso)

### 2.1 Router (tyyppireititin)
Syötteestä tunnistetaan:
- `digital_pdf` vs `scanned_pdf` vs `image`
- `image_music_sheet` (nuottisivu) vs `image_document`

### 2.2 Pipeline-linjat

**A) Digital PDF**
- Extract natiivi teksti
- Taulukot (layout/structure)
- Merge → `document.json`/`document.md`

**B) Scanned PDF**
- Renderöi sivut
- OCR (Tesseract ensisijainen) + adaptive PSM
- Teksti vs taulukko -erottelu
- Merge

**C) Image Document (JPG/PNG)**
- OCR + layout
- JSON/MD

**D) Music Sheet (JPG/PNG)**
- Staff detect (router)
- OMR (Audiveris) → MusicXML → JSON/MD
- Tekstiblokit marginaaleista (metadata)

---

## 3) Versioned canvases (kehityspolku)

### V1–V8: Tilinpäätös/PDF
- v1: perusrakenne, stepit 00–70
- v2: nolladata-ongelman malli (Step 41B pakollinen)
- v3: uusajo + verifiointi
- v4: OCR stabilointi (PaddleOCR fail + fallback)
- v5: Tesseract pakolliseksi, PaddleOCR eristys
- v6: OCR-laadun kovennus + semanttinen luokittelu
- v7: TOC list_item -mallinnus + OCR quality gate + min QA
- v8: adaptive PSM integroituna + TOC→target pages + advanced QA (rajattu)

### V9: Nuottisivu (JPG)
- v9: router staff-detect + OMR-haara (Audiveris→MusicXML→JSON/MD)

---

## 4) Definition of Done (projektitaso)

### 4.1 Tilinpäätös DoD
- Full-run 150–200 sivua onnistuu
- `document.json` ei tyhjä
- TOC tunnistuu ja ohjaa kohdesivuille
- `financial_type` tunnistaa vähintään: income_statement, balance_sheet, cash_flow_statement, notes
- QA-checkerit tuottavat löydöksiä ja läpäisevät minimitason:
  - OCRQualityChecker
  - SemanticSectionChecker
  - BalanceSheetEquationChecker
  - SumConsistencyChecker
  - CrossRefChecker
  - DiffChecker (golden)

### 4.2 Nuottisivu DoD
- `is_music_sheet=true`
- `music/music.xml` (MusicXML) syntyy
- `music/music.json` sisältää tahteja ja nuotteja (ei `measure_count=0`)
- metadata (title/composer/dedication) löytyy

---

## 5) Käyttö (CLI)

### 5.1 PDF
```bash
python -m src.pipeline.run_all --pdf data/00_input/Lapua-Tilinpaatos-2024.pdf
```

### 5.2 Image (dokumentti)
```bash
python -m src.pipeline.run_all --image data/00_input/page.jpg
```

### 5.3 Music sheet (image)
```bash
python -m src.pipeline.run_all --image data/00_input/7x7.jpg
```

---

## 6) Repo-ohjeiden sijoittelu (suositus)

Lisää repojuureen:
- `PROJECT.md` (tämä dokumentti)
- `docs/roadmap.md` (v1–v9 canvases tiivistetty)
- `docs/dod.md` (DoD ja QA)

---

## 7) Seuraavat konkreettiset työtehtävät

### PDF-linja
1) Full-run 154 sivua + gate: bad% < 10–20%
2) Offset-mäppäys (TOC sivunumerot → PDF page_index) luotettavaksi
3) Golden + DiffChecker regressiot

### Music sheet -linja
1) OMR-integraatio Audiveris-CLI:llä
2) MusicXML → JSON parser
3) Staff-maskaus tekst-OCR:lle (metadata vain marginaaleista)

---

## 8) Ydinmuistisäännöt
- Ensin data, sitten semantiikka, sitten QA.
- Tyhjä output = FAIL.
- Kaikki päätökset logitetaan.

