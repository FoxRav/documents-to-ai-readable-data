# V10: OMR Production Path (Audiveris Integration)

## Tavoite
Muuttaa nuottisivu-pipeline "tunnistajasta" **musiikin lukijaksi**.

**Kriittinen mittari:** `measure_count > 0`

---

## Gate A: Audiveris CLI Integration

### A1: Asenna Audiveris
```bash
# Windows: Lataa installer
# https://github.com/Audiveris/audiveris/releases

# Tai: Build from source (Java 17+)
git clone https://github.com/Audiveris/audiveris.git
cd audiveris && ./gradlew build
```

### A2: Testaa CLI
```bash
# Batch mode, export MusicXML
Audiveris.bat -batch -export -output ./out ./input.jpg
```

### A3: Integroi src/music/omr.py
- [x] `find_audiveris()` - löytää asennuksen
- [x] `run_audiveris()` - ajaa CLI:n
- [x] `parse_musicxml()` - parsii tuloksen
- [ ] Lisää timeout handling (>5 min = FAIL)
- [ ] Lisää error recovery (corrupt output)

### DoD Gate A:
- [ ] `Audiveris.bat -help` toimii
- [ ] `omr.success = true` testikuvalla
- [ ] MusicXML tallentuu `music/music.xml`

---

## Gate B: MusicXML → JSON Normalization

### B1: Nuotti-skeema (AI-optimoitu)
```python
@dataclass
class Note:
    pitch: str       # "C4", "D#5"
    duration: str    # "quarter", "half", "whole"
    duration_beats: float  # 1.0, 0.5, 2.0
    beat_position: float   # 1.0, 1.5, 2.0
    measure: int
    voice: int = 1
    is_rest: bool = False
    is_chord: bool = False
    ties: list[str] = []  # ["start", "stop"]

@dataclass  
class Measure:
    number: int
    time_signature: str  # "4/4", "6/8"
    key_signature: str   # "C", "G", "F#m"
    tempo: int | None    # BPM
    notes: list[Note]
    total_beats: float   # Validointi
```

### B2: Parser laajennukset
- [ ] Chord detection (simultaneous notes)
- [ ] Rest handling
- [ ] Tie/slur parsing
- [ ] Absolute beat positions
- [ ] Multi-voice support

### DoD Gate B:
- [ ] `music.json` sisältää `measures[].notes[]`
- [ ] Jokainen nuotti: pitch + duration + beat_position
- [ ] Tahdin nuottien kesto = time_signature

---

## Gate C: QA v2 (OMR-aware)

### C1: Uudet QA-säännöt
```python
# music_qa.py

def check_omr_available(result: dict) -> Finding:
    """FAIL if Audiveris installed but OMR failed."""
    if find_audiveris() and not result.get("omr", {}).get("success"):
        return Finding(severity="fail", message="OMR failed despite Audiveris being installed")

def check_measure_duration(measure: Measure) -> Finding:
    """WARN if measure duration != time signature."""
    expected = parse_time_sig(measure.time_signature)  # e.g., 4.0 for 4/4
    actual = sum(n.duration_beats for n in measure.notes)
    if abs(expected - actual) > 0.01:
        return Finding(severity="warning", 
                      message=f"Measure {measure.number}: expected {expected} beats, got {actual}")

def check_note_validity(note: Note) -> Finding:
    """ERROR if note has invalid data."""
    if note.duration_beats <= 0:
        return Finding(severity="error", message=f"Note has zero duration")
    if not re.match(r"[A-G][#b]?\d", note.pitch):
        return Finding(severity="error", message=f"Invalid pitch: {note.pitch}")
```

### C2: QA Status Matrix
| Condition | Status |
|-----------|--------|
| `is_music_sheet=false` | N/A |
| `omr.success=true`, `measure_count>0`, no errors | PASS |
| `omr.success=true`, `measure_count>0`, warnings | PASS (with warnings) |
| `omr.success=true`, `measure_count=0` | FAIL |
| `omr.success=false`, Audiveris installed | FAIL |
| `omr.success=false`, Audiveris NOT installed | WARN |

### DoD Gate C:
- [ ] QA reports accurate status
- [ ] measure_count=0 with Audiveris = FAIL
- [ ] Duration validation runs on all measures

---

## Gate D: Integration & DoD

### D1: Unified Output
```
music/
├── music.json    # Strukturoitu data (notes, measures, metadata)
├── music.md      # Human-readable summary
├── music.xml     # MusicXML (Audiveris output)
└── qa_report.json
```

### D2: Full DoD (V10)
- [ ] `is_music_sheet = true`
- [ ] `omr.success = true`
- [ ] `measure_count > 0`
- [ ] `music.json` contains `measures[].notes[]`
- [ ] Each note has: pitch, duration, beat_position
- [ ] Metadata complete: title, composer
- [ ] QA status = PASS (no errors)
- [ ] `music.xml` generated

---

## Tehtävälista (Cursor)

### Vaihe 1: Audiveris Setup
1. [ ] Lataa ja asenna Audiveris
2. [ ] Testaa: `Audiveris.bat -help`
3. [ ] Testaa: `Audiveris.bat -batch -export -output ./test ./7x7.jpg`
4. [ ] Varmista MusicXML syntyy

### Vaihe 2: Integration
5. [ ] Päivitä `src/music/omr.py` - paranneltu error handling
6. [ ] Aja: `python -m src.pipeline.run_all --image data/00_input/.../7x7.jpg`
7. [ ] Varmista `music/music.xml` syntyy
8. [ ] Varmista `omr.success = true`

### Vaihe 3: Parser
9. [ ] Laajenna `parse_musicxml()` - chord, rest, tie support
10. [ ] Lisää `duration_beats` laskenta
11. [ ] Lisää `beat_position` laskenta
12. [ ] Testaa monimutkaisemmalla nuottisivulla

### Vaihe 4: QA
13. [ ] Implementoi `check_omr_available()`
14. [ ] Implementoi `check_measure_duration()`
15. [ ] Päivitä QA status matrix
16. [ ] Päivitä `docs/dod.md`

### Vaihe 5: Validation
17. [ ] Full test: 7x7.jpg
18. [ ] Varmista kaikki DoD-kriteerit täyttyvät
19. [ ] Tallenna golden output

---

## Timeline Estimate

| Gate | Effort | Dependency |
|------|--------|------------|
| A: Audiveris CLI | 1-2h | Audiveris install |
| B: MusicXML Parser | 2-4h | Gate A |
| C: QA v2 | 1-2h | Gate B |
| D: Integration | 1h | Gate C |

**Total: 5-9 hours** (riippuu Audiveris-asennuksen sujuvuudesta)

---

## Riskit

1. **Audiveris ei tunnista nuotteja** → kokeile eri input-formaatteja (PNG vs JPG vs PDF)
2. **MusicXML-varianssi** → Audiveris voi tuottaa eri formaattia kuin standardi
3. **Java-riippuvuus** → Audiveris vaatii Java 17+

---

## Seuraava askel

Kun olet valmis, aloita **Gate A** asentamalla Audiveris.
