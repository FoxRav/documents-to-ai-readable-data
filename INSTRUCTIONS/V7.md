# Cursor-ohje | PDF-tyyppireititin — Canvas v7

## Tarkoitus (v7)
V6 mini-run (3 sivua) tuotti ei-tyhjän `document.json` ja semanttiset kentät eivät enää ole kaikkialla null → **edistys**. fileciteturn2file0

Mutta laatu ei vielä riitä täysajoon/QA:han:
- Page 2 sisältää selvästi **sisällysluettelon kaltaista sisältöä**, mutta se on edelleen mallinnettu koko sivun tauluna ja `semantic_section` jäi `appendix`-fallbackiksi. fileciteturn2file1turn2file2
- OCR-kohinaa on yhä paljon (pitkät `cccc/eeee/...`-jonot), mikä rikkoo luokittelua ja myöhempää analyysiä. fileciteturn2file1turn2file2
- QA ei tee mitään, koska `financial_type` on null eikä tarkistuksille löydy kohteita (sum/balance/xref/diff tyhjiä). fileciteturn2file3

V7 lisää:
1) **Laatugatet (OCR-noise gate)** ennen kuin data hyväksytään
2) **TOC ja otsikkosivujen mallinnuksen korjaus** (ei koko sivu taulukoksi)
3) **financial_type täyttyy** vähintään TOC:n perusteella
4) **QA-esivalmistelu** (minimitarkistukset kytketään semantiikkaan)

---

# 1) V7 Gate A — OCR-laadun mittarit ja "noise gate"

## 1.1 Lisää sivukohtaiset laatumittarit
Lisää `step_42_ocr_quality.py` (tai osaksi Step 41B):

Laske per-sivu:
- `alpha_ratio` = aakkosmerkkien osuus
- `digit_ratio` = numeroiden osuus
- `repeat_run_max` = pisin sama merkki peräkkäin (esim. "eeeeeeee")
- `junk_token_ratio` = tokenit jotka ovat 1–3 merkkiä ja eivät muodosta sanoja (heuristiikka)
- `avg_word_len`

Tallenna `debug/ocr_quality.json` ja lisää `page.ocr_quality` kentäksi `document.json`:iin.

## 1.2 Noise gate -säännöt (v7)
Jos jokin toteutuu:
- `repeat_run_max >= 10` TAI
- `alpha_ratio < 0.30` JA `digit_ratio < 0.05`

→ merkitse sivu `ocr_quality.status = "bad"` ja tee:
- aja **toinen OCR-pass** eri PSM:llä (ks. 1.3)
- jos edelleen bad: liputa finding ja salli sivulle vain minimaalinen teksti (älä tee taulukoita)

## 1.3 Adaptive PSM (Tesseract)
Toteuta automaattinen toinen ajo:
- Pass 1: `PSM=6`
- Pass 2 (jos bad): `PSM=11` (sparse text)
- Pass 3 (jos edelleen bad): `PSM=4` (single column) tai `PSM=3`

Valitse paras pass `ocr_quality.score` perusteella.

---

# 2) V7 Gate B — TOC:n tunnistus ja mallinnus (ei taulukoksi)

## 2.1 TOC-detektio (pakollinen)
Lisää `is_toc_page(page_items)` sääntö:
- löytyy avainsana: `sisällysluettelo` / `sisallysluettelo` / `contents`
TAI
- löytyy useita rivejä, joissa on:
  - otsikkoteksti + "dotted leaders" ("....") + sivunumero oikeassa reunassa
  - useita kohtanumeroita: `7.3`, `8.4.1`, jne.

Page 2 data näyttää tältä (kohdanumerot + pisteviivat + sivunumerot) → pitäisi trigata TOC. fileciteturn2file1turn2file2

## 2.2 Mallinnusmuutos
Kun `is_toc_page == true`:
- ÄLÄ tallenna elementtiä `table`
- muunna rivit:
  - `list_item` (kohdanumero + otsikko)
  - `text` (otsikko "Sisällysluettelo")
  - `page_ref` kenttä (sivunumero) jos löydettävissä

Output:
- `page.semantic_section = "toc"`
- itemit: `semantic_type in {text, list_item}`

---

# 3) V7 Gate C — financial_type täyteen (minimitaso)

V6:ssa `financial_type` jäi null. fileciteturn2file1

Lisää luokittelu, joka täyttää `financial_type` vähintään kahdesta lähteestä:

## 3.1 TOC-pohjainen financial_type
Jos sivu on TOC:
- Etsi rivit joissa esiintyy:
  - `tuloslaskelma` → `income_statement`
  - `rahoituslaskelma` → `cash_flow_statement`
  - `tase` → `balance_sheet`
  - `liitetiedot` → `notes`

Tallenna `classification_evidence` (löydetty avainsana + rivi).

## 3.2 Otsikko-/header-pohjainen financial_type
Jos sivu ei ole TOC:
- tarkista yläosan 20% tekstiblokeista avainsanat (FI/EN)
- jos match → aseta `page.semantic_section` ja itemien `financial_type`

---

# 4) V7 Gate D — QA-esivalmistelu (minimi)

QA-report on nyt tyhjä, koska tarkistuksia ei ajeta kohteille. fileciteturn2file3

Lisää vähintään nämä kaksi, ennen varsinaisia sum/balance-checkereita:

## 4.1 SemanticSectionChecker (minimi)
- Vaadi, että mini-runissa löytyy vähintään:
  - `cover`
  - `toc` (kun testataan TOC-sivulla)
- Full-runissa vaadi, että löytyy:
  - `income_statement` ja `balance_sheet` jostain (TOC tai otsikkosivu riittää aluksi)

## 4.2 OCRQualityChecker
- Lisää finding, jos `ocr_quality.status == bad`
- Näytä top-5 huonointa sivua (page_index + score)

---

# 5) V7-ajojärjestys

1) **Mini-run uudestaan**: valitse sivut joissa varmasti on TOC (ei pelkkä 1–3 sivua jos ne eivät sisällä sisällysluetteloa)
2) Varmista:
   - `page.semantic_section == toc` vähintään yhdellä sivulla
   - TOC ei ole `table`
   - `financial_type` täyttyy TOC-riveistä
   - `qa_report.json` sisältää vähintään semantic + ocr-quality findingit
3) Vasta sitten: full-run 154 sivua

---

# 6) V7 Definition of Done

V7 on valmis, kun:
- TOC-sivu mallinnetaan `toc`-osioksi ja list-items blokkeina (ei taulukoksi)
- `financial_type` ei ole kaikkialla null (ainakin TOC:sta tunnistuu)
- `qa_report.json` sisältää semantic- ja ocr-quality -findingit
- OCR-noise gate estää pitkien "cccc/eeee"-jonojen päätymisen taulukkomalliin

---

# 7) V7 → V8

Kun V7 DoD täyttyy:
- ota käyttöön varsinaiset QA-checkerit (SumConsistency, BalanceSheet, CrossRef, Diff)
- ota visual tables -polku vain niille sivuille, joissa `financial_type` on primary statement

