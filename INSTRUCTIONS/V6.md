# Cursor-ohje | PDF-tyyppireititin — Canvas v6

## Tarkoitus (v6)
V6 on **korjauskierros**, joka nostaa tuotoksen laadun analyysikelpoiseksi.

V5 testiajossa data virtasi (document.json ei tyhjä), mutta:
- OCR-laatu on kohinainen (”eeee/cccc”)
- Sivut/elementit tulkittiin väärin (koko sivu taulukoksi)
- Semanttinen luokittelu puuttuu (`semantic_*` = null)
- QA-checkerit eivät löydä mitään, koska niillä ei ole luokiteltua kohdetta

V6 tekee 2 asiaa tässä järjestyksessä:
1) **OCR-laadun kovennus (Tesseract)**
2) **Semanttinen luokittelu + tekstin/taulukon erottelu**

---

# 0) V6-periaate

> Älä lisää QA-checkereita ennen kuin (a) OCR-laatu on siedettävä ja (b) semanttinen luokittelu tuottaa ei-null arvot.

---

# 1) V6 Gate A — OCR-laadun kovennus (Tesseract)

## 1.1 Lisää Tesseract-konfigurointi asetuksiksi
Lisää `settings.py` / `.env`:
- `TESS_LANG=fin+eng`
- `TESS_PSM=6`
- `TESS_OEM=1`
- `OCR_RENDER_DPI=400`

## 1.2 Pakollinen pre-processing (ennen OCR)
Lisää `src/ocr/preprocess.py`:
- grayscale
- adaptive threshold (tai Otsu)
- denoise (kevyt)
- deskew (vain jos kulma havaitaan)

Tavoite:
- vähennä kohinaa, jotta Tesseract ei näe pisteviivoja ja taustaa kirjaimina.

## 1.3 OCR smoke test laajennus
Päivitä `tools/ocr_smoke_test.py`:
- tulosta:
  - keskimääräinen merkkitiheys
  - ei-aakkosmerkkien osuus
  - top-10 trigrammit (havaitse “eee/ccc”)

Gate A DoD:
- kohinatrigrammit vähenevät
- tekstissä on luettavia sanoja (otsikoita)

---

# 2) V6 Gate B — Tekstiblokki vs taulukko (koko sivu ei saa olla taulukko)

## 2.1 Uusi heuristiikka: “TOC / dotted leaders”
Lisää `src/normalize/block_type_refine.py`:

Sääntöjä:
- Jos sivun “taulukko” sisältää rivit joissa:
  - paljon pisteviivoja (`.....`)
  - sivunumeroita oikeassa reunassa
  - vähän numeerisia sarakkeita

→ tulkitse se **sisällysluetteloksi** ja muunna:
- taulukko → `text` + `list_item` blokit

## 2.2 Taulukon validointisääntö
Jos taulukon:
- sarakemäärä < 2 TAI
- numeeristen arvojen osuus < X% (esim. 10%)

→ älä hyväksy taulukoksi, vaan tekstiblokiksi

Gate B DoD:
- sisällysluettelo ei tule taulukkona
- `document.md` näyttää rakenteeltaan järkevämmältä

---

# 3) V6 Gate C — Semanttinen luokittelu (Step 55 pakolliseksi)

## 3.1 Toteuta Step 55 oikeasti
Varmista, että `step_55_semantic_classify.py`:
- ajaa aina Step 50:n jälkeen
- kirjoittaa `financial_type` ja `semantic_type`
- ei jätä kaikkea `null`

## 3.2 Minimitaksonomia v6 (riittää etenemiseen)
Page-level `semantic_section`:
- `cover`
- `toc`
- `management_report`
- `income_statement`
- `balance_sheet`
- `cash_flow_statement`
- `notes`
- `appendix`

Element-level `semantic_type`:
- `title`
- `section_header`
- `text`
- `list_item`
- `table`
- `page_header`
- `page_footer`

## 3.3 Säännöt (v6)
Luokittelu tehdään sääntöjen avulla:

1) Otsikko-avainsanat (FI/EN) blokkien alusta:
- `tase`, `balance sheet`, `statement of financial position` → `balance_sheet`
- `tuloslaskelma`, `income statement` → `income_statement`
- `rahoituslaskelma`, `cash flow` → `cash_flow_statement`
- `liitetiedot`, `notes` → `notes`
- `sisällysluettelo`, `contents` → `toc`

2) TOC-heuristiikka (Gate B) pakottaa `toc`

3) Taulukkoheuristiikat:
- jos löytyy “Vastaavaa/Vastattavaa” tai “Assets/Liabilities” → `balance_sheet`
- jos löytyy “Toimintatuotot/Toimintakulut/Verotulot” → `income_statement`

## 3.4 Output-vaatimus
Lisää `document.json`:
- Page: `semantic_section`, `semantic_confidence`, `classification_evidence[]`
- Item: `semantic_type`, `financial_type`, `classification_evidence[]`

Gate C DoD:
- `semantic_section` ei ole kaikkialla null
- pääosioille löytyy vähintään 1 sivu (tase/tulos)

---

# 4) V6 Gate D — Mini-run + full-run

## 4.1 Mini-run (3–5 sivua)
Aja sivut:
- 1 kansi/otsikko
- 1 sisällysluettelo
- 1 selkeä taulukkosivu
- 1 liitesivu

DoD mini-run:
- `document.json` ei tyhjä
- TOC ei ole taulukko
- semanttiset kentät eivät ole null

## 4.2 Full-run
Kun mini-run ok:
- aja koko dokumentti

---

# 5) V6 Definition of Done

V6 on valmis, kun:
- OCR-laatu paranee (kohina vähenee)
- sisällysluettelo ei ole taulukko
- semanttinen luokittelu täyttyy (ei-null)
- `document.md` on luettavissa järkevässä rakenteessa

---

# 6) V6 → V7

Vasta kun V6 DoD täyttyy:
- ota QA-checkerit käyttöön (SemanticSectionChecker, Sum, Balance, CrossRef, Diff)
- ota visual tables (PP-StructureV3) käyttöön taulukoiden solutarkkuutta varten

---

**Muistisääntö:**
> Paranna ensin OCR + rakenne + semantiikka. QA tulee vasta kun sillä on jotain mitä tarkastaa.

